<html>
<head>
<link rel = "stylesheet" type = "text/css" href = "style.css">
<script src = "perlin.js"></script>
<script>
var FPS = 10.0; //don't need this to be very high, even less than 1.0 is fine
var GAME_SPEED = 100.0; //ticks per minute (default 1.0)

var frames; //frames since last tick

var stocks;

var time;

var graphType = true;
var currGraph = -1;
var stockId = 0;

var mouseX = -1;
var mouseY = -1;

var cash = 1000;

function Stock(name, abbv, time) {
	this.name = name;
	this.abbv = abbv;
	this.offset = time - Math.round(Math.random() * 100);
	
	this.id = stockId;
	stockId++;
	
	this.zeropoint = -1.1444;
	this.amplitude = (5 + 95 * Math.random());
	
	this.perlinZoom = 0.001 + 0.005 * Math.random();
	this.perlinPersist = 0.4 + 0.4 * Math.random() - this.amplitude * 0.001;
	
	this.amount = 0; //number of units that the player has bought
	
	this.getPrice = function(t) {
		var price = (perlin.pnoise((t - this.offset) * this.perlinZoom, this.perlinPersist, 10, this.perlinSeed) - this.zeropoint) * this.amplitude;
		return Math.round(price * 1000) / 1000;
	}
	
	do {
		this.perlinSeed = Math.round(Math.random() * 10000);
	} while(this.getPrice(time) < 0);
	
	this.getChange = function(t) {
		return this.getPrice(t) - this.getPrice(t - 1);
	}
	
	this.getStockDiv = function(t) {
		var stockDiv = document.createElement("div");
		stockDiv.className = "stock";
		var change = this.getChange(t);
		var stockAbbv = document.createElement("p");
		stockAbbv.innerHTML = this.abbv;
		var stockName = document.createElement("p");
		stockName.innerHTML = this.name;
		var stockChange = document.createElement("c");
		if(change > 0) {
			stockChange.className = "up";
			stockChange.innerHTML = "&#9650;&ensp;";
		}
		if(change < 0) {
			stockChange.className = "down";
			stockChange.innerHTML = "&#9660;&ensp;";
		}
		stockChange.innerHTML += Math.abs(change).toFixed(3);
		var stockValue = document.createElement("v");
		stockValue.innerHTML = this.getPrice(t).toFixed(3);
		
		stockDiv.appendChild(stockAbbv);
		stockDiv.appendChild(stockName);
		stockDiv.appendChild(stockValue);
		stockDiv.appendChild(stockChange);
		
		stockDiv.id = "stock" + this.abbv;
		
		var thisId = this.id;
		stockDiv.onclick = function() { clickStock(thisId); };
		return stockDiv;
	}
	
	this.updateStockDiv = function(t) {
		var stockDiv = document.getElementById("stock" + this.abbv);
		if(stockDiv == null) return false;
		
		var stockValue = stockDiv.childNodes[2];
		stockValue.innerHTML = this.getPrice(t).toFixed(3);
		
		var change = this.getChange(t);
		var stockChange = stockDiv.childNodes[3];
		if(change > 0) {
			stockChange.className = "up";
			stockChange.innerHTML = "&#9650;&ensp;";
		} else if(change < 0) {
			stockChange.className = "down";
			stockChange.innerHTML = "&#9660;&ensp;";
		} else {
			stockChange.className = "";
			stockChange.innerHTML = "";
		}
		stockChange.innerHTML += Math.abs(change).toFixed(3);
		
		return true;
	}
	
	this.getHigh = function(tStart, tEnd) {
		var maximum = -10000;
		for(var i = tStart; i <= tEnd; i++) {
			if(this.getPrice(i) > maximum) {
				maximum = this.getPrice(i);
			}
		}
		return maximum;
	}
	
	this.getLow = function(tStart, tEnd) {
		var minimum = 10000;
		for(var i = tStart; i <= tEnd; i++) {
			if(this.getPrice(i) < minimum) {
				minimum = this.getPrice(i);
			}
		}
		return minimum;
	}
	
	this.drawStockGraph = function(tStart, tEnd, canvas) {
		//intervalSize = (tEnd - tStart) / (canvas.width - 30) * 25; //used to be manually input
		intervalSize = Math.max((tEnd - tStart) / 12, 5);
		
		//range / intervalsize = width / barsize = num of bars
		//intervalsize = range * barsize / width = range / num of bars
	
		var ctx = canvas.getContext("2d");
		//Clear canvas
		ctx.fillStyle = "#FFFFFF";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		
		//Draw graph axes
		ctx.strokeStyle = "#000000";
		ctx.beginPath();
		ctx.moveTo(20, 10);
		ctx.lineTo(20, canvas.height - 20);
		ctx.lineTo(canvas.width - 10, canvas.height - 20);
		ctx.stroke();
		
		//Figure out how many bars are needed
		var barCount = Math.ceil((tEnd - tStart) / intervalSize); //If the range is not divisible by the interval, round up; the first bar will have incomplete data
		//Spacing between bars is 3px; find bar width
		var barWidth = Math.floor((canvas.width - 30 - 3 * barCount) / barCount) + 3;
		//Figure out the scale of the y-axis
		var lowest = Math.floor(this.getLow(tStart, tEnd) / 20) * 20;
		var highest = Math.ceil(this.getHigh(tStart, tEnd) / 20) * 20;
		var scale = (canvas.height - 30) / (highest - lowest);
		var yLabelInterval = 5;
		while((highest - lowest) / yLabelInterval > (canvas.height - 30) / 40 && yLabelInterval < 20) yLabelInterval *= 2;
		
		// Label the graph
		ctx.fillStyle = "#000000";
		ctx.font = "24px Lucida";
		ctx.fillText(this.name, (canvas.width - ctx.measureText(this.name).width) / 2, 30);
		ctx.fillText(this.abbv, (canvas.width - ctx.measureText(this.abbv).width) / 2, 60);
		
		ctx.font = "12px Lucida";
		for(var i = 0; i <= (highest - lowest) / yLabelInterval; i++) {
			var text = (lowest + i * yLabelInterval) + "";
			ctx.fillText(text, 18 - ctx.measureText(text).width, canvas.height - 18 - (i * (canvas.height - 30) * yLabelInterval / (highest - lowest)));
		}
		
		//Draw the bars
		for(var i = 0; i < barCount; i++) {
			//Get data for this bar
			var ts = Math.max(tEnd - (barCount - i) * intervalSize, tStart);
			var te = tEnd - (barCount - i - 1) * intervalSize;
			var open = this.getPrice(ts);
			var close = this.getPrice(te);
			var high = this.getHigh(ts, te);
			var low = this.getLow(ts, te);
			//Draw the back line
			ctx.strokeStyle = "#000000";
			ctx.beginPath();
			ctx.moveTo(23 + (i + 0.5) * barWidth, canvas.height - 20 - (low - lowest) * scale);
			ctx.lineTo(23 + (i + 0.5) * barWidth, canvas.height - 20 - (high - lowest) * scale);
			ctx.stroke();
			//Draw the bar
			ctx.fillStyle = close > open ? "#00FF00" : "#FF0000";
			ctx.fillRect(23 + i * barWidth, canvas.height - 20 - (Math.max(open, close) - lowest) * scale, barWidth - 3, Math.abs(open - close) * scale);
		}
	}
	
	this.drawLineGraph = function(tStart, tEnd, canvas) {
		var ctx = canvas.getContext("2d");
		//Clear canvas
		ctx.fillStyle = "#FFFFFF";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		
		//Draw graph axes
		ctx.strokeStyle = "#000000";
		ctx.beginPath();
		ctx.moveTo(20, 10);
		ctx.lineTo(20, canvas.height - 20);
		ctx.lineTo(canvas.width - 10, canvas.height - 20);
		ctx.stroke();
		
		//Figure out the scale of the y-axis
		var lowest = Math.floor(this.getLow(tStart, tEnd) / 20) * 20;
		var highest = Math.ceil(this.getHigh(tStart, tEnd) / 20) * 20;
		var scale = (canvas.height - 30) / (highest - lowest);
		var yLabelInterval = 5;
		while((highest - lowest) / yLabelInterval > (canvas.height - 30) / 40 && yLabelInterval < 20) yLabelInterval *= 2;
		
		//x-difference between subsequent points
		var dist = (canvas.width - 30) / (tEnd - tStart);
		var xLabelInterval = 5;
		while((tEnd - tStart) / xLabelInterval > (canvas.width - 30) / 40) xLabelInterval *= 2;
		
		// Label the graph
		ctx.fillStyle = "#000000";
		ctx.font = "24px Lucida";
		ctx.fillText(this.name, (canvas.width - ctx.measureText(this.name).width) / 2, 30);
		ctx.fillText(this.abbv, (canvas.width - ctx.measureText(this.abbv).width) / 2, 60);
		
		ctx.font = "12px Lucida";
		for(var i = 0; i <= (highest - lowest) / yLabelInterval; i++) {
			var text = (lowest + i * yLabelInterval) + "";
			ctx.fillText(text, 18 - ctx.measureText(text).width, canvas.height - 18 - (i * (canvas.height - 30) * yLabelInterval / (highest - lowest)));
		}
		for(var i = 0; i <= (tEnd - tStart) / xLabelInterval; i++) {
			var text = (tStart + i * xLabelInterval) + "";
			ctx.fillText(text, 20 + (i * (canvas.width - 30) * xLabelInterval / (tEnd - tStart)) - ctx.measureText(text).width / 2, canvas.height - 5);
		}
		
		ctx.strokeStyle = "#000000";
		ctx.beginPath();
		ctx.moveTo(20, canvas.height - 20 - (this.getPrice(tStart) - lowest) * scale);
		//Last x drawn at
		var x = 19;
		var skipSum = 0; //for averages
		var skipCount = 0;
		var drawnMousePoint = false;
		for(var i = 0; i <= tEnd - tStart; i++) {
			var currX = Math.floor(i * dist) + 20;
			skipSum += this.getPrice(i + tStart);
			skipCount++;
			var currY = canvas.height - 20 - (skipSum / skipCount - lowest) * scale;
			if(mouseX != -1 && !drawnMousePoint && currX + dist * 0.5 > mouseX) {
				ctx.fillStyle = "#000000";
				ctx.font = "16px Lucida";
				ctx.fillRect(currX - 2, currY - 2, 4, 4);
				ctx.fillText("Time: " + (i + tStart), canvas.width / 2 - 50, canvas.height - 40);
				ctx.fillText("Price: " + this.getPrice(i + tStart).toFixed(3), canvas.width / 2 + 50, canvas.height - 40);
				drawnMousePoint = true;
			}
			
			if(currX > x) {
				x = currX;
				ctx.lineTo(currX, currY);
				skipSum = 0;
				skipCount = 0;
			}
		}
		ctx.stroke();
	}
}

function init() {
	frames = 0;
	time = 0;
	
	stocks = new Array();
	stocks.push(new Stock("Bob's Bananas", "BB", 0));
	stocks.push(new Stock("John's Jam", "JJ", 0));
	stocks.push(new Stock("Steve's Spaghetti", "SPG", 0));
	stocks.push(new Stock("Alpha Apples", "AAP", 0));
	stocks.push(new Stock("Gamma Grapes", "GG", 0));
	stocks.push(new Stock("Omega Oranges", "OMG", 0));
	stocks.push(new Stock("Pi Potatoes", "PIP", 0));
	stocks.push(new Stock("Sigma Strawberries", "SS", 0));
	stocks.push(new Stock("Rho Raspberries", "RHR", 0));
	stocks.push(new Stock("Beta Blueberries", "BBB", 0));
	
	updateStockHolder(time);
	
	tick();
}

function updateStockHolder(t) {
	var stockHolder = document.getElementById("stockholder");
	//stockHolder.innerHTML = "";
	for(var i = 0; i < stocks.length; i++) {
		if(!stocks[i].updateStockDiv(t)) {
			stockHolder.appendChild(stocks[i].getStockDiv(t));
		}
	}
}

function tick() {
	frames++;
	if(frames >= 60.0 * FPS / GAME_SPEED) {
		frames = 0;
		//Do special stuff
		time++;
		updateStockHolder(time);
	}
	//Do less special stuff
	updateGraph();
	updateInfoLeft();
	updateInfoRight();
	
	setTimeout(tick, 1000.0 / FPS);
}

function updateGraph() {
	//Draw the currently selected graph
	var canvas = document.getElementById("graphcanvas");
	canvas.width = canvas.parentElement.scrollWidth - 10;
	canvas.height = canvas.parentElement.scrollHeight - 10;
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		if(graphType) {
			stocks[currStockIndex].drawLineGraph(-20, time, canvas);
		} else {
			stocks[currStockIndex].drawStockGraph(-20, time, canvas);
		}
	} else {
		var ctx = canvas.getContext("2d");
		ctx.fillStyle = "#FFFFFF";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle = "#000000";
		ctx.font = "24px Lucida";
		var text = "Select a stock to see a graph";
		ctx.fillText(text, (canvas.width - ctx.measureText(text).width) / 2, canvas.height / 2 - 12);
	}
}

function updateInfoLeft() {
	var infodiv = document.getElementById("infoleft");
	infodiv.innerHTML = "";
	infodiv.innerHTML += "<p>Cash: " + cash.toFixed(3) + "</p>\n";
	if(totalStockOwned() > 0) {
		var tabletext = "<table><tr><td>Stock</td><td>Units</td><td>Value</td></tr>";
		for(var i = 0; i < stocks.length; i++) {
			if(stocks[i].amount > 0) {
				tabletext += "<tr><td>" + stocks[i].abbv + "</td><td>" + stocks[i].amount + "</td><td>" + (stocks[i].getPrice(time) * stocks[i].amount).toFixed(3) + "</td></tr>";
			}
		}
		tabletext += "</table>";
		infodiv.innerHTML += tabletext;
	} else {
		infodiv.innerHTML += "<p>No stock owned. Buy some!</p>";
	}
}

function updateInfoRight() {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var stock = stocks[currStockIndex];
		document.getElementById("infostockname").innerHTML = stock.name;
		document.getElementById("infostockabbv").innerHTML = stock.abbv;
		document.getElementById("infoowned").innerHTML = "Owned: " + stock.amount;
		var amt = parseInt(document.getElementById("buysellamt").value);
		if(!amt) amt = 0;
		document.getElementById("buybutton").innerHTML = "Buy for " + (stock.getPrice(time) * amt).toFixed(3);
		document.getElementById("sellbutton").innerHTML = "Sell for " + (stock.getPrice(time) * amt).toFixed(3);
		document.getElementById("buyallbutton").innerHTML = "Buy Max for " + (stock.getPrice(time) * Math.floor(cash / stock.getPrice(time))).toFixed(3);
		document.getElementById("sellallbutton").innerHTML = "Sell All for " + (stock.getPrice(time) * stock.amount).toFixed(3);
	} else {
		document.getElementById("infostockname").innerHTML = "Select a stock";
		document.getElementById("infostockabbv").innerHTML = "to see info here";
		document.getElementById("infoowned").innerHTML = "";
		document.getElementById("buybutton").innerHTML = "Buy...";
		document.getElementById("sellbutton").innerHTML = "Sell...";
		document.getElementById("buyallbutton").innerHTML = "Buy Max";
		document.getElementById("sellallbutton").innerHTML = "Sell All";
	}
}

function totalStockOwned() { //price of all owned stocks
	var total = 0;
	for(var i = 0; i < stocks.length; i++) {
		total += stocks[i].amount * stocks[i].getPrice(time);
	}
	return total;
}

function doTurn() {
	graphType = !graphType;
}

function clickStock(id) {
	currGraph = id;
}

function stockIdToIndex(id) {
	for(var i = 0; i < stocks.length; i++) {
		if(stocks[i].id == id) return i;
	}
	return -1;
}

function graphMouseMove(e) {
	mouseX = e.layerX - 2;
	mouseY = e.layerY - 2;
	updateGraph();
}

function graphMouseLeave(e) {
	mouseX = -1;
	mouseY = -1;
}

function buyButton() {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var amt = parseInt(document.getElementById("buysellamt").value);
		buyStock(amt);
	}
}

function sellButton() {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var amt = parseInt(document.getElementById("buysellamt").value);
		sellStock(amt);
	}
}

function buyAllButton() {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var stock = stocks[currStockIndex];
		var amt = Math.floor(cash / stock.getPrice(time));
		buyStock(amt);
	}
}

function sellAllButton() {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var stock = stocks[currStockIndex];
		var amt = stock.amount;
		sellStock(amt);
	}
}

function buyStock(amt) {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var stock = stocks[currStockIndex];
		//Ensure that we have enough money
		if(amt * stock.getPrice(time) <= cash) {
			stock.amount += amt;
			cash -= amt * stock.getPrice(time);
		} else {
			//Not enough money
		}
	}
}

function sellStock(amt) {
	var currStockIndex = stockIdToIndex(currGraph);
	if(currStockIndex != -1) {
		var stock = stocks[currStockIndex];
		//Ensure that we have enough stock
		if(stock.amount <= amt) {
			stock.amount -= amt;
			cash += amt * stock.getPrice(time);
		}
	}
}
</script>
</head>
<body onselectstart = "return false">
<div class = "stockholder" id = "stockholder"></div>
<div class = "graphholder">
	<canvas id = "graphcanvas" onmousemove = "graphMouseMove(event)" onmouseleave = "graphMouseLeave(event)"></canvas>
</div>
<div id = "infoleft" class = "infoholderleft">
</div>
<div id = "inforight" class = "infoholderright">
	<p id = "infostockname">Select a stock</p>
	<p id = "infostockabbv">to see info here</p><br>
	<p id = "infoowned">Owned: 0</p>
	<div class = "button" id = "buybutton" onclick = "buyButton()" style = "width:30%;height:35px">Buy for 00000.000</div>
	<input type = "text" id = "buysellamt" placeholder = "Amount" style = "width:30%;height:45px;"></input>
	<div class = "button" id = "sellbutton" onclick = "sellButton()" style = "width:30%;height:35px;">Sell for 00000.000</div><br><br>
	<div class = "button" id = "buyallbutton" style = "width:45.5%;height:35px;" onclick = "buyAllButton()">Buy Max for 00000.000</div>
	<div class = "button" id = "sellallbutton" style = "width:45.5%;height:35px;" onclick = "sellAllButton()">Sell All for 00000.000</div><br><br>
</div>
<script>
window.onload = init;
</script>
</body>
</html>